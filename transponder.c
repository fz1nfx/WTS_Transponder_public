/*
 * File:   transponder.c
 * Author: Waldemar Borek
 *
 * PIC16F18313 WTS Transponder firmware
 */
#include "mcc_generated_files/mcc.h"

#include "transponder.h"

struct dataset_t {
    uint8_t MessageID[12]; 
    uint8_t Status1[12];
    uint8_t Status2[12];
    uint8_t Status3[12];
    uint8_t Status4[12];
    uint8_t Status5[12];
    uint8_t Status6[12];
    uint8_t Status7[12];
};

#ifdef BUTTON_ENABLED
#define TR_ID_NUMBER_MAX 8

const struct dataset_t dataset[TR_ID_NUMBER_MAX]=
{ 
  // Transponder ID 1    
    {{0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11}},

  // Transponder ID 2
	{{0xf9, 0x16, 0x22, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11}},

  // Transponder ID 3
    {{0xf9, 0x16, 0x33, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11}},
 
  // Transponder ID 4 
	{{0xf9, 0x16, 0x44, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11}},

  // Transponder ID 5
    {{0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11}},
 
  // Transponder ID 6
    {{0xf9, 0x16, 0x66, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11}},
 
  // Transponder ID 7
    {{0xf9, 0x16, 0x77, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11}},
      
  // Transponder ID 8
    {{0xf9, 0x16, 0x88, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11}}
};
#else
const struct dataset_t dataset[1]=
{ 
  // Transponder ID   
    {{0xf9, 0x16, 0x99, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11},
	 {0xf9, 0x16, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11}}
};
#endif

volatile uint8_t MessageRAM[14] __at(0x70);   // place for message to send in RAM, this needs to be in shared RAM at address 0x70

uint8_t ledON = 0; //Counter for led toggle  
uint8_t ledOFF = 0; //Counter for led toggle 
uint16_t randomDelay = 0; //random number for delay
uint8_t counterID = 0; // counter for MessageID send
uint8_t counterST = 1; // counter for Status send
uint8_t dataset_number = 0; // dataset number to send
__eeprom uint8_t dataset_number_eeprom = 0;
extern void sendmsg(void);

void msgDelay()
{
    uint8_t a;
    
    // random delay between two MSG
    // Delay = 0.002 seconds
    // Clock frequency = 20 MHz
    // Actual delay = 0.002 seconds = 10000 cycles
    // Error = 0 %
    __delay_ms(2);

    // Additional delay random ; Delay = 0.0001 0.0002 0.0004 0.0008 seconds
    // total delay from  2 to 2.8 ms
    // delay = 0.0001 seconds = 500 cycles
    
    for(a = 0; a < randomDelay; a++)
    {
        //Debug("delay_us(100)\n\r");
        __delay_us(100);
    }
    randomDelay++;
    if(randomDelay > 6)
    {
        randomDelay = 0;
    }
    //*******************************
}

void toggleLED()
{
    //*******************************
    // toggle LED
    if(0 == PORTAbits.RA2)
    {
        ledOFF++;
        if(ledOFF > 250)
        {
            LED_ON;
            ledOFF = 0;
        }
    }
    else
    {
        ledON++;
        if(ledON > 20)
        {
            LED_OFF;
            ledON = 0;
        }
    }
    //*******************************
}

#ifdef BUTTON_ENABLED
void selectTansponderID()
{
    #define EXIT_COUNTER 3
    
    uint8_t a; //loop counter
    uint8_t exit_counter = EXIT_COUNTER;
    
    // read from eeprom dataset number -> TransponderID select
    dataset_number = dataset_number_eeprom;
    
    if(PORTAbits.RA3 == 1)
    {
        Debug("Skip change ID mode\n\r");
        for(a = 0; a < (dataset_number+1);a++)
        {
            __delay_ms(300);
            LED_ON;
            __delay_ms(300);
            LED_OFF;
        }
        __delay_ms(10);        
        return;
    }
    Debug("Enter change ID mode\n\r");
    LED_ON;
    
    // wait for button release
    while(PORTAbits.RA3 == 0)
    {
        __delay_ms(50);
    }
    __delay_ms(500);
    LED_OFF;
    
    while(1)
    {
        // show TR ID on LED
        for(a = 0; a < (dataset_number+1);a++)
        {
            __delay_ms(300);
            LED_ON;
            __delay_ms(300);
            LED_OFF;
        }
       
        // wait for TR change 3sec
        for(a = 0; a < 60; a++)
        {
            if(PORTAbits.RA3 == 0)
            {
                dataset_number++;
                if(dataset_number > (TR_ID_NUMBER_MAX - 1))
                {
                    dataset_number = 0;
                }
                // wait for button release
                while(PORTAbits.RA3 == 0)
                {
                    __delay_ms(50);
                }
                a = 0; // reset 3 sec wait
                exit_counter = EXIT_COUNTER+1;
            }
            __delay_ms(50);    
        }
        
        exit_counter--;
        if(exit_counter == 0)
        {
            // store TR ID in eeprom and exit
            dataset_number_eeprom = dataset_number;
            __delay_ms(2000);
            return;
        }
    
    }
              
    // done - exit
    __delay_ms(2000);
}
#endif

#if 0
void SendMsg_Debug()
{
    //Debug("SendMessage = ");
#if 0    
    Debug("0x%X ", MessageRAM[0]);
    Debug("0x%X ", MessageRAM[1]);
    Debug("0x%X ", MessageRAM[2]);
    Debug("0x%X ", MessageRAM[3]);
    Debug("0x%X ", MessageRAM[4]);
    Debug("0x%X ", MessageRAM[5]);
    Debug("0x%X ", MessageRAM[6]);
    Debug("0x%X ", MessageRAM[7]);
    Debug("0x%X ", MessageRAM[8]);
    Debug("0x%X ", MessageRAM[9]);
    Debug("0x%X ", MessageRAM[10]);
    Debug("0x%X ", MessageRAM[11]);
#endif    
    //Debug("\n\r");
    
}
#endif

void SendMessage()
{
    // print on uart message to send
    //SendMsg_Debug();
    
    sendmsg();
    
    msgDelay();
    toggleLED();
}

void CopyMessage(const uint8_t *Message)
{
    uint8_t a;
    
    for(a = 0; a < 12; a++)
    {
        MessageRAM[a] = Message[a];
    }
}

void transponder(void)
{
//*******************************************************************************
// MAIN PROGRAM
//*******************************************************************************
    
    Debug("waldo.borek@gmail.com\n\r");


    //SETUP
    TRISA = 0b00111111;   
    SLRCONA = 0b00000100; 
    CLKRCON = 0b10010010;  // Setup  clock reference to a 5MHz 50% duty cycle extraced by dividing by 4 main clock
                           // Divide 4 by because crystal clock is 4x by PLL 

    //*******************************
    // Digital Signal Modulator setup
    MDCON = 0;

    // Setup Modulation source
    MDSRC = 0;

    // Setup carrier High
    MDCARH = 0b00100011;

    // Setup carrier Low reverted   
    MDCARL = 0b01100011;
    // END of Digital Signal Modulator setup
    //*******************************

    //*******************************
    // Setup CLC1 = DSM out 

    // Setup CLC1CON output to reproduce DSM out 
    CLC1CON =  0b00000100;  
    CLC1SEL0 = 0b00001010;      
    CLC1SEL1 = 0b00011111; 
    CLC1SEL2 = 0b00011111; 
    CLC1SEL3 = 0b00011111;            
    CLC1POL = 0b00000000; 
    CLC1GLS0 = 0b00001000; 
    CLC1GLS1 = 0b00000010; 
    CLC1GLS2 = 0; 
    CLC1GLS3 = 0; 

    // END Setup CLC1 
    //*******************************

    //*******************************
    // Setup CWG 
    CWG1CON0bits.EN = 0; 
    CWG1CON0 = 0b00000100;             
    CWG1CON1 = 0; 
    CWG1CLKCON = 0; 
    CWG1DBR = 0; 
    CWG1DBF = 0;         
    CWG1AS1 = 0; 
    CWG1STR = 0; 
    CWG1DAT = 0b00001010; 
    CWG1AS0 = 0b10101000;    
    // End of setup CWG 
    //*******************************

    //*******************************  
    // Assign output pins

    INTCONbits.GIE = 0; 
    PPSLOCK = 0x55; 
    PPSLOCK = 0xAA;            
    PPSLOCKbits.PPSLOCKED = 0;  
    RA0PPS = 0b00001000;    
    RA1PPS = 0b00001001; 
    PPSLOCK = 0x55;            
    PPSLOCK = 0xAA;
    PPSLOCKbits.PPSLOCKED = 1;
    INTCONbits.GIE = 1; 
    CWG1CON0bits.EN = 1; 

    PORTA = 0; // Init PORTA
    LATA = 0; // Data Latch
    ANSELA = 0; // digital I/O

    ODCONA = 0; 
    TRISAbits.TRISA0 = 0; // RA0 is output 
    TRISAbits.TRISA1 = 0; // RA1 is output
    TRISAbits.TRISA2 = 0; // RA2 is output
    WPUAbits.WPUA3 = 1; // Weak pull up enabled on port RA3

    // End Assign output pins
    //*******************************

    #ifdef BUTTON_ENABLED
    // select TransponderID dataset
    selectTansponderID();
    #endif

    //*******************************
    // Main program loop start
    while (1)
        {
            Debug("Main loop start \r\n");

            //*******************************
            // send MessageID 3 times
            for(counterID = 0; counterID < 3; counterID++)
            {
                CopyMessage((const uint8_t*)&(dataset[dataset_number].MessageID));

                //send MessageID from MessageRAM
                SendMessage();
            }
            //*******************************    

            //*******************************
            // send Status
            switch(counterST)
            {
                case 1 :
                {
                    CopyMessage((const uint8_t*)&(dataset[dataset_number].Status1));
                }
                break; 

                case 2 :
                {
                    CopyMessage((const uint8_t*)&(dataset[dataset_number].Status2));
                }
                break;

                case 3 :
                {
                    CopyMessage((const uint8_t*)&(dataset[dataset_number].Status3));
                }
                break;

                case 4 :
                {
                    CopyMessage((const uint8_t*)&(dataset[dataset_number].Status4));
                }
                break;

                case 5 :
                {
                    CopyMessage((const uint8_t*)&(dataset[dataset_number].Status5));
                }
                break;

                case 6 :
                {
                    CopyMessage((const uint8_t*)&(dataset[dataset_number].Status6));
                }
                break;

                case 7 :
                {
                    CopyMessage((const uint8_t*)&(dataset[dataset_number].Status7));
                }
                break; 		            
            }
            SendMessage();
            counterST++;
            if(counterST > 7)
            {
                counterST = 1;
            }
            //*******************************

        }
    // Main program loop end
    //*******************************

}
